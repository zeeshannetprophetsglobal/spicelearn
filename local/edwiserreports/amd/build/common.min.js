"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","core/str","local_edwiserreports/variables","local_edwiserreports/selectors","local_edwiserreports/templateselector","local_edwiserreports/jspdf","local_edwiserreports/select2","local_edwiserreports/jquery.dataTables","local_edwiserreports/dataTables.bootstrap4"],function(e,t,o,a,n,r,i,s,l,d,c){var u=null,f="#scheduletab",p=f+" .dropdown a.dropdown-item",m="button.dropdown-toggle",g=f+" .dropdown.duration-dropdown a.dropdown-item",h=f+" input#esr-sendduration",y=f+" .dropdown:not(.duration-dropdown)",b=y+" button.dropdown-toggle",v=y+" a.dropdown-item",w=f+" .dropdown.daily-dropdown button.dropdown-toggle",k=f+" .dropdown.weekly-dropdown button.dropdown-toggle",_=f+" .dropdown.monthly-dropdown button.dropdown-toggle",x=f+" input#esr-sendtime",S="#listemailstab .esr-email-sched-setting",T="#listemailstab .esr-email-sched-delete",O="#listemailstab [id^='esr-toggle-']",j=M.util.get_string("scheduleerrormsg","local_edwiserreports"),C=M.util.get_string("schedulesuccessmsg","local_edwiserreports"),q=M.util.get_string("deletesuccessmsg","local_edwiserreports"),N=M.util.get_string("deleteerrormsg","local_edwiserreports"),R=M.util.get_string("emptyerrormsg","local_edwiserreports"),J=M.util.get_string("emailinvaliderrormsg","local_edwiserreports"),E='[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane',z='[aria-controls="scheduletab"], #scheduletab',D='<div id="cover-spin"></div>',U={show:function(t){var o;null==t?(t="body",o="position-fixed"):o="position-absolute",e(t).append('\n            <div class="edwiserreports-loader '.concat(o,'">\n                <i class="fa fa-circle-o-notch fa-spin" aria-hidden="true"></i>\n            </div>\n            '))},hide:function(t){null==t&&(t="body"),e(t+" > .edwiserreports-loader").remove()}};function F(t){t.modal.find(".comparisontable .switch-capability").on("click",function(t){var o=e(t.currentTarget).find("input[type=radio]"),a=o.filter(":checked"),n=o.eq(o.index(a)+1);0===n.length&&(n=o.eq(0)),n.prop("checked",!0);var r=n.data("strpermission"),i=n.data("permissionclass");e(t.currentTarget).removeClass("inherit allow prevent prohibit"),e(t.currentTarget).addClass(i),e(t.currentTarget).find("label").html(r)})}function P(t,o){var a=o.getRoot().find("#esr-shceduled-emails");return e(document).on("click",'[aria-controls="listemailstab"]',function(){e(window).resize()}),a.DataTable({ajax:{url:s.requestUrl+"?sesskey="+t.sesskey,type:s.requestType,data:{action:"get_scheduled_emails_ajax",data:JSON.stringify({blockname:t.block,region:t.region})}},language:{searchPlaceholder:"Search shceduled email",emptyTable:"There is no scheduled emails",sClass:"text-center"},drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")},order:[[2,"asc"]],columns:[{data:"esrname",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,bInfo:!1,lengthChange:!1})}return e(document).ready(function(){e(document).on("click",'.download-links button[value="pdf"]',function(t){t.preventDefault();var o=e(this).closest("form");e.ajax({url:o.attr("action"),type:"POST",data:{type:e(this).val(),block:o.find('input[name="block"]').val(),filter:o.find('input[name="filter"]').val(),cohortid:o.find('input[name="cohortid"]').val(),region:o.find('input[name="region"]').val()}}).done(function(e){e=JSON.parse(e);var t=c("p","pt","a4"),o={top:40,bottom:30,left:10,width:"100%"};t.setFontSize(10);t.fromHTML(e.data.html,o.left,o.top,{width:o.width,elementHandlers:{"#bypassme":function(e,t){return!0}}},function(o){t.save(e.data.filename)},o)}).always(function(){e(document).find("#cover-spin").hide()})}),e(document).on("click",'.download-links button[value="email"]',function(o){o.preventDefault();var l=s.getScheduledEmailFormContext(),d=e(this).closest("form").serializeArray();e(d).each(function(e,t){l[t.name]=t.value}),a.create({title:M.util.get_string("scheduleemailfor","local_edwiserreports")+" "+M.util.get_string(l.block+"exportheader","local_edwiserreports"),body:r.render("local_edwiserreports/email_schedule_tabs",l)},e(this)).done(function(o){var a=o.getRoot();o.modal.addClass("modal-lg"),a.on(n.bodyRendered,function(){a.find("#esr-blockname").val(l.blockname),a.find("#esr-region").val(l.region),a.find("#esr-sesskey").val(l.sesskey),u=P(l,o)}),a.on(n.hidden,function(){o.destroy()}),function(o,a,n){a.on("click",p,function(){var t,o,a,n;o=e(t=this).data("value"),a=e(t).text(),(n=e(t).closest(".dropdown").find(m)).text(a),n.data("value",o)}),a.on("click",g,function(){!function(t,o){var a=e(t).data("value");o.find(h).val(a),e(b).hide();var n=null;switch(a){case 1:n=e(k);break;case 2:n=e(_);break;default:n=e(w)}n.show();var r=n.data("value");e(x).val(r)}(this,a)}),a.on("click",v,function(){a.find(x).val(e(this).data("value"))}),a.on("click",S,function(){!function(t,o){var a=e(t).data("id"),n=e(t).data("blockname"),r=e(t).data("region");e.ajax({url:s.requestUrl,type:s.requestType,sesskey:e(t).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:e(t).data("sesskey"),data:JSON.stringify({id:a,blockname:n,region:r})}}).done(function(t){(t=JSON.parse(t)).error?console.log(t):(!function(t,o,a){var n=null,r=null;e.each(t.data,function(t,o){if("object"===_typeof(o))a.find("#esr-blockname").val(o.blockname),a.find("#esr-region").val(o.region);else if("esrduration"===t){var i='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+o+'"]';n=o,a.find(i).click()}else if("esrtime"===t)r=o;else if("esremailenable"===t){var s=e('input[name="'+t+'"]');o?s.prop("checked",!0):s.prop("checked",!1)}else e('[name="'+t+'"]').val(o)});var i='.dropdown-item[data-value="'+r+'"]',s=null;switch(n){case"1":s=e(".weekly-dropdown");break;case"2":s=e(".monthly-dropdown");break;default:s=e(".daily-dropdown")}s.find(i).click()}(t,0,o),o.find(E).removeClass("active show"),o.find(z).addClass("active show"))}).fail(function(e){console.log(e)})}(this,a)}),a.on("click",T,function(r){o.id=e(this).data("id"),i.get_strings([{key:"confirmemailremovaltitle",component:"local_edwiserreports"},{key:"confirmemailremovalquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(i){t.confirm(i[0],i[1],i[2],i[3],e.proxy(function(){!function(t,o,a){var n=t.id,r=t.block,i=t.region,l=o.find(".esr-form-error");l.html(U).show(),e.ajax({url:s.requestUrl,type:s.requestType,sesskey:t.sesskey,data:{action:"delete_scheduled_email_ajax",sesskey:t.sesskey,data:JSON.stringify({id:n,blockname:r,region:i})}}).done(function(e){e.error?l.html(N):(u&&u.destroy(),u=P(t,a),l.html(q))}).fail(function(e){l.html(N),console.log(e)}).always(function(){l.delay(3e3).fadeOut("slow")})}(o,a,n)},r.currentTarget))})}),a.on("change",O,function(){o.id=e(this).data("id"),function(t,o,a){null;var n=t.id,r=t.block,i=t.region,l=t.sesskey,d=o.find(".esr-form-error");e.ajax({url:s.requestUrl,type:s.requestType,data:{action:"change_scheduled_email_status_ajax",sesskey:l,data:JSON.stringify({id:n,blockname:r,region:i})}}).done(function(e){(e=JSON.parse(e)).error?(d.html(e.errormsg),d.show(),d.delay(3e3).fadeOut("slow")):(d.html(e.successmsg),d.show(),d.delay(3e3).fadeOut("slow"))})}(o,a)}),a.on("click",'[data-action="send"]',function(){!function(t,o,a){var n=t.filter,r=t.cohortid,i=t.block,s=a.find(".esr-form-error");s.html("").show(),e(document).find("#cover-spin")&&e("body").append(D);e(document).find("#cover-spin").show(0),e.ajax({url:M.cfg.wwwroot+"/local/edwiserreports/download.php?type=email&filter="+n+"&cohortid="+r+"&block="+i,type:"POST",data:a.find("form").serialize()}).done(function(t){(t=e.parseJSON(t)).error?s.html('<div class="alert alert-danger"><b>ERROR:</b>'+t.errormsg+"</div>"):s.html('<div class="alert alert-success"><b>Success:</b>'+t.errormsg+"</div>")}).fail(function(e){s.html('<div class="alert alert-danger"><b>ERROR:</b>'+e.errormsg+"</div>")}).always(function(){s.delay(3e3).fadeOut("slow"),e(document).find("#cover-spin").hide()})}(o,0,a)}),function(t,o,a){o.on("click",'[data-action="save"]',function(){var n=o.find(".esr-form-error");if(n.html(U).show(),function(e,t){var o=e.find('[name="esrname"]').val(),a=e.find('[name="esrrecepient"]').val();if(""==o||""==a)return t.html(R).show(),!1;if(!/^(\s?[^\s,]+@[^\s,]+\.[^\s,]+\s?,)*(\s?[^\s,]+@[^\s,]+\.[^\s,]+)$/g.test(a))return t.html(J).show(),!1;return!0}(o.find("form"),n)){var r=t.filter,i=t.cohortid,s=t.block,l=M.cfg.wwwroot+"/local/edwiserreports/download.php?type=emailscheduled&filter="+r+"&cohortid="+i+"&block="+s;e.ajax({url:l,type:"POST",data:o.find("form").serialize()}).done(function(o){(o=e.parseJSON(o)).error?(n.html(j),console.log(o.error)):(u&&u.destroy(),u=P(t,a),n.html(C))}).fail(function(e){n.html(j),console.log(e)}).always(function(){n.delay(3e3).fadeOut("slow")})}}),o.on("click",'[data-action="cancel"]',function(){o.find('[name^=esr]:not(.d-none):not([id="esr-toggle-"])').val(""),o.find("#esr-id").val(-1)})}(o,a,n)}(l,a,o),o.show()})}),e("#wdm-edwiserreports").removeClass("d-none"),e(document).on("click",l.blockSettingsBtn,function(r){r.preventDefault();var i=e(r.currentTarget).data("contextid"),l=e(r.currentTarget).data("blockname"),d=e(r.currentTarget).data("action");if("edit"==d)a.create({title:"Edit Block Setting",body:o.loadFragment("local_edwiserreports","get_blocksetting_form",i,{blockname:l})}).done(function(o){var a=o.getRoot();o.modal.addClass("modal-dialog-centered"),a.on(n.bodyRendered,function(){var a=o.modal.find(".block-settings-form");o.modal.find(".save-block-settings").on("click",function(o){o.preventDefault();var n=a.serializeArray(),r={};e(n).each(function(e,t){r[t.name]=t.value}),function(o,a){a.blockname=o,a=JSON.stringify(a);var n=e("#"+o).data("sesskey");e.ajax({url:s.requestUrl,type:"GET",data:{action:"set_block_preferences_ajax",sesskey:n,data:a}}).fail(function(e){console.log(e),t.addNotification({message:e,type:"error"})}).always(function(){location.reload()})}(l,r)})}),a.on(n.hidden,function(){o.destroy()}),o.show()});else if("hide"==d){var c=e(this).data("hidden"),u=e(this);e.ajax({url:s.requestUrl,type:"GET",data:{action:"toggle_hide_block_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({blockname:l,hidden:c})}}).done(function(e){(e=JSON.parse(e)).success&&(c?(u.closest(".edwiserReport-block").removeClass("block-hidden"),u.data("hidden",0),u.html(M.util.get_string("hide","local_edwiserreports"))):(u.closest(".edwiserReport-block").addClass("block-hidden"),u.data("hidden",1),u.html(M.util.get_string("unhide","local_edwiserreports"))))})}else"editcap"==d&&a.create({title:"Edit Block Capabilities",body:o.loadFragment("local_edwiserreports","get_blockscap_form",i,{blockname:l})}).done(function(a){var r=a.getRoot();a.modal.addClass("modal-dialog-centered modal-lg"),r.on(n.bodyRendered,function(){var n=a.modal.find(".block-cap-form");a.modal.find("#menucapabilities").on("change",function(t){t.preventDefault();var r=n.serializeArray(),s={};e(r).each(function(e,t){s[t.name]=t.value}),o.loadFragment("local_edwiserreports","block_overview_display",i,{capvalue:s.capabilities}).done(function(e,t,o){a.modal.find(".cap-overview").html(e),F(a)})}),F(a),n=a.modal.find(".block-cap-form"),a.modal.find(".save-block-caps").on("click",function(o){o.preventDefault();var r=n.serializeArray(),i={};e(r).each(function(e,t){i[t.name]=t.value}),function(o,a,n){a.blockname=o,a=JSON.stringify(a);var r=e("#"+o).data("sesskey");e.ajax({url:s.requestUrl,type:"GET",data:{action:"set_block_capability_ajax",sesskey:r,data:a}}).done(function(e){(e=JSON.parse(e)).success?(n(),location.reload()):t.addNotification({message:"Error",type:"error"})}).fail(function(e){console.log(e),t.addNotification({message:e,type:"error"})}).always(function(){n(),location.reload()})}(l,i,function(){a.destroy()})})}),r.on(n.hidden,function(){a.destroy()}),a.show()})}),function(t){var o,a='<div id="editing-btn" class="d-flex flex-wrap">';a+='<div class="ml-auto d-flex">',t?(t=0,o="Stop Customising this page",a+='<div class="singlebutton">',a+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',a+='<input type="hidden" name="reset" value="1">',a+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',a+='<button type="submit" class="btn btn-secondary" title="">Reset Page to Default</button>',a+="</form>",a+="</div>"):(t=1,o="Customise this page");a+='<div class="singlebutton">',a+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',a+='<input type="hidden" name="edit" value="'+t+'">',a+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',a+='<button type="submit" class="btn btn-secondary" title="">'+o+"</button>",a+="</form>",a+="</div>",a+="</div></div>",e("#page-local-edwiserreports-index #page-header .card-body").append(a)}(e("#wdm-edwiserreports").data("editing"))}),{loader:U}});
//# sourceMappingURL=common.min.js.map
